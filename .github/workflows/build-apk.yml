name: Build APK on PR

 

on:

  pull_request:

    branches: [ main, master ]

  push:

    branches: [ claude/improve-app-features-011CUoibZq4DEDjVc3jjcQpD ]

  workflow_dispatch:

 

jobs:

  build:

    name: Build Android APK

    runs-on: ubuntu-latest

 

    steps:

      - name: Checkout code

        uses: actions/checkout@v4

 

      - name: Setup Java

        uses: actions/setup-java@v4

        with:

          distribution: 'temurin'

          java-version: '17'

 

      - name: Setup Flutter

        uses: subosito/flutter-action@v2

        with:


          channel: 'stable'

          cache: true

 

      - name: Flutter doctor

        run: flutter doctor -v

 

      - name: Get dependencies

        run: flutter pub get

 

      - name: Build Debug APK

        run: flutter build apk --debug

 

      - name: Build Release APK

        run: flutter build apk --release

 

      - name: Build Split APKs (per ABI)

        run: flutter build apk --release --split-per-abi

 

      - name: Rename APKs with version info

        run: |

          cd build/app/outputs/flutter-apk

          VERSION=$(grep "version:" ../../../../pubspec.yaml | sed 's/version: //' | tr -d ' ')

          mv app-release.apk kratom-tracker-v${VERSION}-release.apk || true

          mv app-debug.apk kratom-tracker-v${VERSION}-debug.apk || true

          ls -lh *.apk

 

      - name: Upload Release APK

        uses: actions/upload-artifact@v4

        with:

          name: kratom-tracker-release-apk

          path: build/app/outputs/flutter-apk/*-release.apk

          retention-days: 14

 

      - name: Upload Debug APK

        uses: actions/upload-artifact@v4

        with:

          name: kratom-tracker-debug-apk

          path: build/app/outputs/flutter-apk/*-debug.apk

          retention-days: 14

 

      - name: Upload Split APKs

        uses: actions/upload-artifact@v4

        with:

          name: kratom-tracker-split-apks

          path: build/app/outputs/flutter-apk/app-*-release.apk

          retention-days: 14

 

      - name: Comment PR with download links

        if: github.event_name == 'pull_request'

        uses: actions/github-script@v7

        with:

          script: |

            const fs = require('fs');

            const runId = context.runId;

            const repo = context.repo;

 

            const comment = `## ðŸ“± APK Build Complete!

 

            Your KratomTracker **BETA** APKs are ready for testing:

 

            ### ðŸ“¥ Download APKs:

            - [**Release APK (Recommended)**](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

            - [Debug APK (Faster install)](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

            - [Split APKs (Smaller size)](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

 

            ### âœ… Beta Build Features:

            - **Installs as separate app** (won't replace your production version)

            - App name: "Herbal Tracker Beta"

            - Package: org.kratomtracker.app.beta

            - Version: 1.1.0-beta

 

            ### ðŸ“‹ Testing Checklist:

            - [ ] Notifications (Enable in Manage, set reminders)

            - [ ] CSV Export (Try all 4 formats)

            - [ ] PDF Report (Generate with date range)

            - [ ] Daily Limit (Set low limit, add dosage)

            - [ ] Advanced Analytics (Check Stats tab)

            - [ ] Tags (Add dosage with tags)

            - [ ] Duplicate Detection (Add same strain twice within 30 min)

 

            ### ðŸ“± Installation:

            1. Click the link above

            2. Scroll to "Artifacts" section at the bottom

            3. Download the APK (Release recommended)

            4. Enable "Install from unknown sources" on your Android device

            5. Install and test alongside your existing app!

 

            **Build triggered by**: ${context.actor}

            **Commit**: ${context.sha.substring(0, 7)}`;

 

            github.rest.issues.createComment({

              issue_number: context.issue.number,

              owner: repo.owner,

              repo: repo.repo,

              body: comment

            });
